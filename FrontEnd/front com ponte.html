<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <title>IPC - Frontend (simulação)</title>
    <style>
        /* Parte CSS*/
        * {
            box-sizing: border-box;
        }

        .formatobotoes {
            display: flex;
            width: 50%;
            gap: 5px;
            margin-top: 8px;
        }

        body {
            font-family: 'Segoe UI',sans-serif;
            background: #d9dbdf;
        }

        .container {
            background: white;
            border-radius: 25px;
            padding: 20px;
        }

        header h2 {
            margin: 0;
        }

        .panel {
            border: 1px solid #4d4b4b;
            padding: 12px;
            border-radius: 20px;
        }

        .arrumawidth {
            width: 50%
        }

        label {
            display: block;
            font-size: 13px;
            margin-bottom: 6px;
        }

        select, input[type=text], button {
            width: 100%;
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #cfd8e3;
        }

        #log {
            height: 400px;
            overflow-y: auto;
            background: rgb(0, 0, 0);
            color: #3e9913;
            padding: 10px;
            border-radius: 10px;
        }

        .msg {
            margin-bottom: 8px;
            padding: 6px 8px;
            border-radius: 6px;
        }

            .msg.me {
                text-align: left;
            }

            .msg.backend {
                text-align: left;
            }

        pre.jsoncaixa {
            height: 120px;
            overflow: auto;
            padding: 8px;
            border-radius: 6px;
            background: #000000;
            color: #3e9913;
            font-size: 13px;
        }

        .mechanism {
            width: 50%;
        }

        .pitico {
            font-size: 12px;
            color: #5b6670;
        }

        #statusespaco {
            margin-bottom: 5px;
        }

        footer {
            text-align: right;
            margin-top: 14px;
            font-size: 12px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">

        <header>
            <h2>Comunicação entre processos</h2>
            <br>
            <div id=statusespaco>
                Status: <strong id="statusText">parado</strong>
            </div>
        </header>

        <div>
            <div class="panel">
                <label for="mechanism">Mecanismo de comunicação entre processos</label>
                <select class=arrumawidth id="mechanism">
                    <option value="" disabled selected hidden> escolha uma opção </option>
                    <option value="pipe">Pipes Anônimos</option>
                    <option value="socket">Sockets (locais)</option>
                    <option value="memcom">Memória Compartilhada</option>
                </select>
                <div class="formatobotoes">
                    <button id="btnStart"> Iniciar </button>
                    <button id="btnStop"> Parar </button>
                </div>
                <br>
                <hr>
                <br>
                <label for="message">Mensagem (entrada)</label>
                <div class=arrumawidth>
                    <input type="text" id="message" placeholder="Digite sua mensagem" />
                </div>
                <div class="formatobotoes">
                    <button id="btnSend">Enviar</button>
                    <button id="btnClear">Limpar log</button>
                </div>

                <p class="pitico">O log vai mostrar tanto entrada quanto saída</p>
            </div>

            <br>

            <div class="panel">
                <label>Log - Mensagens</label>
                <div id="log"></div>
                <hr>
                <label>JSON mais recente</label>
                <pre id="jsonOutput" class="jsoncaixa">(vazio)</pre>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------
        // Variáveis de controle
        // ----------------------------------
        const statusText = document.getElementById('statusText');
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const btnSend = document.getElementById('btnSend');
        const btnClear = document.getElementById('btnClear');
        const logEl = document.getElementById('log');
        const jsonOutput = document.getElementById('jsonOutput');
        const messageInput = document.getElementById('message');
        const mechanismSelect = document.getElementById('mechanism');

        let socket = null;

        // ----------------------------------
        // Helpers
        // ----------------------------------
        function formatTime(d = new Date()) {
            return d.toLocaleString();
        }

        function appendLog(text, cls = 'me') {
            const div = document.createElement('div');
            div.className = 'msg ' + cls;
            div.innerHTML = `<small class="pitico">${formatTime()}</small><div>${escapeHtml(text)}</div>`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/\"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function setStatus(running) {
            statusText.textContent = running ? 'rodando' : 'parado';
        }

        // ----------------------------------
        // Eventos
        // ----------------------------------
        btnStart.addEventListener('click', () => {
            socket = new WebSocket("ws://localhost:8080");

            socket.onopen = () => {
                setStatus(true);
                appendLog("Conectado ao backend via ponte Node.js", 'backend');
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    appendLog(`${data.role} → ${data.event}: ${data.status}`, 'backend');
                    jsonOutput.textContent = JSON.stringify(data, null, 2);
                } catch (e) {
                    appendLog("Mensagem inválida do backend: " + event.data, 'backend');
                }
            };

            socket.onclose = () => {
                setStatus(false);
                appendLog("Conexão fechada com o backend", 'backend');
            };
        });

        btnStop.addEventListener('click', () => {
            if (socket) {
                socket.close();
                socket = null;
            }
            setStatus(false);
        });

        btnSend.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (!text || !socket) return;

            const mechanism = mechanismSelect.value || "socket";

            const payload = {
                mechanism: mechanism,
                mensagem: text
            };

            socket.send(JSON.stringify(payload));
            appendLog(`Você → ${mechanism}: "${text}"`, 'me');
            messageInput.value = '';
        });

        btnClear.addEventListener('click', () => {
            logEl.innerHTML = '';
            jsonOutput.textContent = '(vazio)';
        });

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') btnSend.click();
        });

        // Inicializa status
        setStatus(false);

        console.log('IPC Frontend conectado ao backend real (Node.js + C++).');
    </script>
</body>
</html>
